<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/x-icon" href="favicon.ico" />
    <title>Powershell Web</title>
    <style>
        html, body {
            font-family: Consolas, monospace;
            background: #012456;
            color: white;
            font-size: 14px;
        }

        pre {
            font-family: inherit;
            font-size: 1rem;
            margin: 0;
            padding: 0;
        }

        input {
            font-family: inherit;
            font-size: 1rem;
            background: none;
            color: white;
            border: none;
            width: 100%;
            outline: none;
        }

        input:focus {
                outline: none;
            }

        button {
            border: none;
            background: none;
            float: right;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <button onclick="showLogin()"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-shield"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg></button>

    <div id="console"></div>

    <div style="margin-top: 1rem;">
        <div class="folder" id="folder" style="margin-right: 2px"></div><input type="text" id="console-input" />
    </div>

    <script>

        var polling = null;
        var history = {};
        var historyCount = 0;

        var folder = document.getElementById("folder");
        document.getElementById("console-input").focus();

        document.getElementById("console-input").addEventListener("keyup", function (event) {
          // return pressed
            if (event.keyCode === 13) {
              event.preventDefault();
                var commandInp = document.getElementById("console-input").value;
                sendCommand(commandInp);
                document.getElementById("console-input").value = "";
                polling = setInterval(() => fetchAnswer(), 800);
            }

            // arrow up
            if (event.keyCode === 38) {
              getHistory(historyCount);
              historyCount++;
              var historyLength = getHistoryCount() - 1;
              if (historyCount > historyLength) {
                historyCount = historyLength;
              }
            }

            // arrow down
            if (event.keyCode === 40) {
              historyCount--;
              if (historyCount < 0) {
                document.getElementById("console-input").value = "";
                historyCount = 0;
              } else {
                getHistory(historyCount);
              }
            }

        });

        function showLogin() {
            var key = window.prompt("Set client password:");
            localStorage.setItem("key", key);
        }

        function getHistoryCount() {
          return Object.keys(history).length;
        }

        function addHistory(command) {
          var currentHistoryLength = getHistoryCount();
          history[currentHistoryLength] = command;
        }

        function getHistory(count) {
          var currentHistoryLength = getHistoryCount();
          var getCount = currentHistoryLength - count - 1;
          if (getCount < 0) {
            getCount = 0;
          }
          document.getElementById("console-input").value = history[getCount];
        }

        function sendCommand(commandString) {

          addHistory(commandString);
            var data = new FormData();
            data.append("cmd", commandString);
            data.append("key", localStorage.getItem("key"));

            fetch('/command', {
                method: 'POST',
                body: data
            }).then(function (response) {
                return response.json();
            }).then(function (answer) {

                if (answer.Error > 0) {
                    window.alert(answer.Result);
                    clearInterval(polling);
                }

            }).catch(function (error) {
                window.alert(error);
            });
        }

        function printAnswer(answerLine) {
            
            var el = document.createElement("pre");
            el.innerHTML = answerLine;
            document.getElementById("console").appendChild(el);
            window.scrollTo(0, document.body.scrollHeight);
        }

        function fetchAnswer() {

            fetch('/status').then(function (response) {
                return response.json();
            }).then(function (answer) {

                if (Number(answer.Count) > 0) {
                  printAnswer(answer.Result);
                } else {
                  clearInterval(polling);
                  fetchFolder();
                }
            }).catch(function (error) {
                console.log(error);
                clearInterval(polling);
            });

        }

        function fetchFolder() {
          fetch('/folder').then(function (response) {
            return response.json();
          }).then(function (answer) {

            if (answer.Error > 0) {
              window.alert(answer.Result);
            }

            folder.innerHTML = answer.Result;

          }).catch(function (error) {
            window.alert(error);
          });
        }

        polling = setInterval(() => fetchAnswer(), 800);



    </script>

</body>
</html>